import{j as e}from"./ui-B52-YLhK.js";import{r as c}from"./vendor-BcRnq7Bv.js";import{u as ce,s as P,r as n,C as x,b as N,B as o,t as v,I as ne,i as oe,j as de,k as me,l as xe,m as he,D as B,h as j,e as u,d as T,g as y,E as w,A as E,n as M,o as F}from"./index-CwOpWW1C.js";import{a as ge,S as pe,F as O,I as b}from"./image-upload-CCixpRm1.js";import{T as je,a as ue,b as A,c as q}from"./tabs-D5GWy4pF.js";import{D as $,a as fe,b as H,c as W,d as G,e as J}from"./dialog-C51BNC8a.js";import{T as Ne}from"./textarea-CV_jgnQH.js";import{P as ve}from"./plus-B1hUgeE_.js";import{M as _}from"./map-pin-OatoSQae.js";import{C as k}from"./circle-check-CjnywA-A.js";import{C as K}from"./clock-NqfEd9ie.js";import{f as C}from"./utils-BT0ItAA-.js";import"./supabase-B83k6j1z.js";function Me(){const{profile:t}=ce(),[S,Q]=c.useState([]),[X,Y]=c.useState(!0),[Z,z]=c.useState(!1),[i,I]=c.useState(null),[ee,d]=c.useState(!1),[f,R]=c.useState(!1),[h,se]=c.useState(!1),[l,m]=c.useState({title:"",description:"",work_location:"",images:[]}),ae=["Office - Main Building","Office - Branch Location","Client Site","Remote - Home","Remote - Co-working Space","Field Work","Other"];c.useEffect(()=>{U()},[t]);const U=async()=>{try{let s=P.from("project_updates").select(`
          *,
          profiles!project_updates_employee_id_fkey(*)
        `).order("created_at",{ascending:!1});t?.role==="employee"?s=s.eq("employee_id",t.id):t?.role==="manager"&&(s=s.or(`employee_id.eq.${t.id}`));const{data:a,error:r}=await s;if(r)throw r;Q(a||[])}catch(s){console.error("Error fetching project updates:",s),n.error("Failed to fetch project updates")}finally{Y(!1)}},re=async s=>{if(s.preventDefault(),!(!t||f||h)){if(h){n.error("Please wait for images to finish uploading");return}if(!l.title.trim()){n.error("Please enter a project title");return}if(!l.description.trim()){n.error("Please enter a description");return}if(!l.work_location){n.error("Please select a work location");return}R(!0);try{const{error:a}=await P.from("project_updates").insert({employee_id:t.id,title:l.title.trim(),description:l.description.trim(),work_location:l.work_location,images:l.images.length>0?l.images:null,status:"submitted"});if(a)throw a;n.success("Project update submitted successfully"),z(!1),m({title:"",description:"",work_location:"",images:[]}),U()}catch(a){console.error("Error creating project update:",a),n.error("Failed to submit project update")}finally{R(!1)}}},V=async(s,a)=>{try{const{error:r}=await P.from("project_updates").update({status:a,updated_at:new Date().toISOString()}).eq("id",s);if(r)throw r;n.success(`Project update ${a} successfully`),U()}catch(r){console.error("Error updating project status:",r),n.error("Failed to update project status")}},te=s=>{m(a=>({...a,images:[...a.images,s]}))},ie=s=>{m(a=>({...a,images:a.images.filter(r=>r!==s)}))},D=s=>{switch(s){case"approved":return e.jsxs(j,{className:"bg-green-100 text-green-800",children:[e.jsx(k,{className:"mr-1 h-3 w-3"}),"Approved"]});case"submitted":return e.jsxs(j,{className:"bg-blue-100 text-blue-800",children:[e.jsx(K,{className:"mr-1 h-3 w-3"}),"Submitted"]});default:return e.jsxs(j,{className:"bg-gray-100 text-gray-800",children:[e.jsx(O,{className:"mr-1 h-3 w-3"}),"Draft"]})}},L=S.filter(s=>s.employee_id===t?.id),g=S.filter(s=>s.status==="submitted"),le=()=>(t?.role==="manager"||t?.role==="super_admin")&&g.length>0?"pending-reviews":"my-updates";return X?e.jsx("div",{className:"space-y-6",children:e.jsx("div",{className:"grid gap-4",children:[...Array(3)].map((s,a)=>e.jsx(x,{children:e.jsxs(N,{className:"animate-pulse",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-1/2"})]})},a))})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold tracking-tight",children:"Project Updates"}),e.jsx("p",{className:"text-muted-foreground",children:"Share your project progress with images and detailed descriptions"})]}),e.jsxs($,{open:Z,onOpenChange:s=>!f&&!h&&z(s),children:[e.jsx(fe,{asChild:!0,children:e.jsxs(o,{className:"bg-gray-600 hover:bg-gray-700 text-white",children:[e.jsx(ve,{className:"mr-2 h-4 w-4"}),"New Update"]})}),e.jsxs(H,{className:"max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(W,{children:[e.jsx(G,{children:"Create Project Update"}),e.jsx(J,{children:"Fill out the form to submit a new project update. Images can be uploaded to showcase progress."})]}),e.jsxs("form",{onSubmit:re,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"title",children:"Project Title"}),e.jsx(ne,{id:"title",placeholder:"Enter project or task title...",value:l.title,onChange:s=>m({...l,title:s.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"work_location",children:"Work Location"}),e.jsxs(oe,{value:l.work_location,onValueChange:s=>m({...l,work_location:s}),children:[e.jsx(de,{children:e.jsx(me,{placeholder:"Select work location"})}),e.jsx(xe,{children:ae.map(s=>e.jsx(he,{value:s,children:s},s))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"description",children:"Description & Progress"}),e.jsx(Ne,{id:"description",placeholder:"Describe what you've accomplished, challenges faced, next steps...",value:l.description,onChange:s=>m({...l,description:s.target.value}),rows:6,required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"Project Images"}),e.jsx(ge,{onImageUploaded:te,onImageRemoved:ie,currentImages:l.images,maxImages:8,bucket:"projects",userId:t?.id||"",onUploadStateChange:se})]}),e.jsx(o,{type:"submit",disabled:f||h,className:"w-full bg-gray-600 hover:bg-gray-700 text-white disabled:opacity-50",children:f?e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"mr-2 h-4 w-4 animate-spin"}),"Submitting..."]}):h?e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"mr-2 h-4 w-4 animate-spin"}),"Uploading Images..."]}):e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"mr-2 h-4 w-4"}),"Submit Update"]})})]})]})]})]}),e.jsxs(je,{defaultValue:le(),className:"space-y-4",children:[e.jsxs(ue,{children:[e.jsx(A,{value:"my-updates",children:"My Updates"}),(t?.role==="manager"||t?.role==="super_admin")&&e.jsxs(A,{value:"pending-reviews",children:["Pending Reviews",g.length>0&&e.jsx(j,{className:"ml-2 bg-red-500 text-white",children:g.length})]}),t?.role==="super_admin"&&e.jsx(A,{value:"all-updates",children:"All Updates"})]}),e.jsx(q,{value:"my-updates",className:"space-y-4",children:L.length===0?e.jsx(x,{children:e.jsx(u,{className:"py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx(O,{className:"mx-auto h-12 w-12 text-muted-foreground"}),e.jsx("h3",{className:"mt-4 text-lg font-semibold",children:"No project updates"}),e.jsx("p",{className:"text-muted-foreground",children:"Start by creating your first project update with images"})]})})}):e.jsx("div",{className:"grid gap-4",children:L.map(s=>e.jsxs(x,{className:"hover:shadow-md transition-shadow",children:[e.jsx(N,{children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(T,{className:"text-xl",children:s.title}),e.jsxs("div",{className:"flex items-center gap-4 mt-2 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(_,{className:"h-4 w-4"}),e.jsx("span",{children:s.work_location})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(y,{className:"h-4 w-4"}),e.jsx("span",{children:C(new Date(s.created_at),"MMM dd, yyyy")})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[D(s.status),e.jsxs(o,{variant:"outline",size:"sm",onClick:()=>{I(s),d(!0)},className:"bg-gray-100 text-gray-600 border-gray-300 hover:bg-gray-200 hover:text-gray-700",children:[e.jsx(w,{className:"h-4 w-4 mr-1"}),"View"]})]})]})}),e.jsxs(u,{children:[e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-3 mb-3",children:s.description}),s.images&&s.images.length>0&&e.jsxs("div",{className:"flex gap-2",children:[s.images.slice(0,4).map((a,r)=>e.jsx("img",{src:b.getOptimizedImageUrl(a,{width:80,height:60,quality:80}),alt:`Project image ${r+1}`,className:"w-16 h-12 object-cover rounded border",onError:p=>{p.currentTarget.src="https://via.placeholder.com/64x48?text=Error"}},r)),s.images.length>4&&e.jsxs("div",{className:"w-16 h-12 bg-gray-100 rounded border flex items-center justify-center text-xs text-gray-500",children:["+",s.images.length-4]})]})]})]},s.id))})}),(t?.role==="manager"||t?.role==="super_admin")&&e.jsx(q,{value:"pending-reviews",className:"space-y-4",children:g.length===0?e.jsx(x,{children:e.jsx(u,{className:"py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx(k,{className:"mx-auto h-12 w-12 text-muted-foreground"}),e.jsx("h3",{className:"mt-4 text-lg font-semibold",children:"No pending reviews"}),e.jsx("p",{className:"text-muted-foreground",children:"All project updates have been reviewed"})]})})}):e.jsx("div",{className:"grid gap-4",children:g.map(s=>e.jsxs(x,{className:"border-blue-200 bg-blue-50",children:[e.jsx(N,{children:e.jsx("div",{className:"flex justify-between items-start",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs(T,{className:"flex items-center gap-2",children:[s.title,e.jsxs(j,{className:"bg-blue-100 text-blue-800",children:[e.jsx(K,{className:"mr-1 h-3 w-3"}),"Pending Review"]})]}),e.jsxs("div",{className:"flex items-center gap-4 mt-2 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(E,{className:"h-5 w-5",children:[e.jsx(M,{src:s.profiles.profile_picture||void 0}),e.jsx(F,{className:"text-xs",children:s.profiles.full_name.split(" ").map(a=>a[0]).join("")})]}),e.jsx("span",{children:s.profiles.full_name})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(_,{className:"h-4 w-4"}),e.jsx("span",{children:s.work_location})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(y,{className:"h-4 w-4"}),e.jsx("span",{children:C(new Date(s.created_at),"MMM dd, yyyy")})]})]})]})})}),e.jsxs(u,{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-4 line-clamp-3",children:s.description}),s.images&&s.images.length>0&&e.jsxs("div",{className:"flex gap-2 mb-4",children:[s.images.slice(0,5).map((a,r)=>e.jsx("img",{src:b.getOptimizedImageUrl(a,{width:80,height:60,quality:80}),alt:`Project image ${r+1}`,className:"w-16 h-12 object-cover rounded border",onError:p=>{p.currentTarget.src="https://via.placeholder.com/64x48?text=Error"}},r)),s.images.length>5&&e.jsxs("div",{className:"w-16 h-12 bg-gray-100 rounded border flex items-center justify-center text-xs text-gray-500",children:["+",s.images.length-5]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(o,{onClick:()=>V(s.id,"approved"),className:"bg-green-600 hover:bg-green-700 text-white",size:"sm",children:[e.jsx(k,{className:"mr-2 h-4 w-4"}),"Approve"]}),e.jsxs(o,{variant:"outline",onClick:()=>{I(s),d(!0)},size:"sm",className:"bg-gray-100 text-gray-600 border-gray-300 hover:bg-gray-200 hover:text-gray-700",children:[e.jsx(w,{className:"mr-2 h-4 w-4"}),"View Details"]})]})]})]},s.id))})}),t?.role==="super_admin"&&e.jsx(q,{value:"all-updates",className:"space-y-4",children:e.jsx("div",{className:"grid gap-4",children:S.map(s=>e.jsxs(x,{children:[e.jsx(N,{children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(T,{className:"text-xl",children:s.title}),e.jsxs("div",{className:"flex items-center gap-4 mt-2 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(E,{className:"h-5 w-5",children:[e.jsx(M,{src:s.profiles.profile_picture||void 0}),e.jsx(F,{className:"text-xs",children:s.profiles.full_name.split(" ").map(a=>a[0]).join("")})]}),e.jsx("span",{children:s.profiles.full_name})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(_,{className:"h-4 w-4"}),e.jsx("span",{children:s.work_location})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(y,{className:"h-4 w-4"}),e.jsx("span",{children:C(new Date(s.created_at),"MMM dd, yyyy")})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[D(s.status),e.jsxs(o,{variant:"outline",size:"sm",onClick:()=>{I(s),d(!0)},className:"bg-gray-100 text-gray-600 border-gray-300 hover:bg-gray-200 hover:text-gray-700",children:[e.jsx(w,{className:"h-4 w-4 mr-1"}),"View"]})]})]})}),e.jsxs(u,{children:[e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-3 mb-3",children:s.description}),s.images&&s.images.length>0&&e.jsxs("div",{className:"flex gap-2",children:[s.images.slice(0,4).map((a,r)=>e.jsx("img",{src:b.getOptimizedImageUrl(a,{width:80,height:60,quality:80}),alt:`Project image ${r+1}`,className:"w-16 h-12 object-cover rounded border",onError:p=>{p.currentTarget.src="https://via.placeholder.com/64x48?text=Error"}},r)),s.images.length>4&&e.jsxs("div",{className:"w-16 h-12 bg-gray-100 rounded border flex items-center justify-center text-xs text-gray-500",children:["+",s.images.length-4]})]})]})]},s.id))})})]}),e.jsx($,{open:ee,onOpenChange:d,children:e.jsxs(H,{className:"max-w-5xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(W,{children:[e.jsxs(G,{className:"flex items-center gap-2",children:[e.jsx(O,{className:"h-5 w-5"}),"Project Update Details"]}),e.jsx(J,{children:"Review the details of the project update, including description and images."})]}),i&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-2xl font-bold",children:i.title}),e.jsxs("div",{className:"flex items-center gap-4 mt-2 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(E,{className:"h-6 w-6",children:[e.jsx(M,{src:i.profiles.profile_picture||void 0}),e.jsx(F,{className:"text-xs",children:i.profiles.full_name.split(" ").map(s=>s[0]).join("")})]}),e.jsx("span",{children:i.profiles.full_name})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(_,{className:"h-4 w-4"}),e.jsx("span",{children:i.work_location})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(y,{className:"h-4 w-4"}),e.jsx("span",{children:C(new Date(i.created_at),"MMM dd, yyyy")})]})]})]}),D(i.status)]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Description & Progress"}),e.jsx("div",{className:"bg-gray-50 p-4 rounded-lg",children:e.jsx("p",{className:"whitespace-pre-wrap text-sm leading-relaxed",children:i.description})})]}),i.images&&i.images.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"font-semibold mb-3",children:["Project Images (",i.images.length,")"]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:i.images.map((s,a)=>e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:b.getOptimizedImageUrl(s,{width:300,height:200,quality:85}),alt:`Project image ${a+1}`,className:"w-full h-32 object-cover rounded border hover:shadow-lg transition-shadow cursor-pointer",onClick:()=>window.open(s,"_blank"),onError:r=>{r.currentTarget.src="https://via.placeholder.com/300x200?text=Error+Loading+Image"}}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all rounded flex items-center justify-center",children:e.jsx(w,{className:"h-6 w-6 text-white opacity-0 group-hover:opacity-100 transition-opacity"})})]},a))})]}),i.status==="submitted"&&(t?.role==="manager"||t?.role==="super_admin")&&e.jsxs("div",{className:"flex gap-2 pt-4 border-t",children:[e.jsxs(o,{onClick:()=>{V(i.id,"approved"),d(!1)},className:"bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(k,{className:"mr-2 h-4 w-4"}),"Approve Update"]}),e.jsx(o,{variant:"outline",onClick:()=>d(!1),className:"bg-gray-100 text-gray-600 border-gray-300 hover:bg-gray-200 hover:text-gray-700",children:"Close"})]})]})]})})]})}export{Me as ProjectUpdates};
